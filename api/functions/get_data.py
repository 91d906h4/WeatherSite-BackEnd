from collections import defaultdict
import requests
import json
from bs4 import BeautifulSoup

def request_api(api):
    res = requests.get(api)
    data = json.loads(res.text)
    return data

def get_weather_data(stationid):
    stationid = str(stationid)
    if stationid[0] in "0123456789":
        url = f'https://opendata.cwb.gov.tw/api/v1/rest/datastore/O-A0003-001?Authorization=CWB-0BFC5710-D0E8-46A4-9B4A-6386C222F445&stationId={stationid}'
    else:
        url = f'https://opendata.cwb.gov.tw/api/v1/rest/datastore/O-A0001-001?Authorization=CWB-0BFC5710-D0E8-46A4-9B4A-6386C222F445&stationId={stationid}'

    weather_data = request_api(url)

    # if api server return nothing
    if len(weather_data["records"]["location"]) == 0: return {"status": "error"}

    list_station = ["station", "station_id", "latitude", "longitude", "latest_update_time"]
    station_data = [weather_data["records"]["location"][0]["locationName"],
                    weather_data["records"]["location"][0]["stationId"],
                    weather_data["records"]["location"][0]["lat"],
                    weather_data["records"]["location"][0]["lon"],
                    weather_data["records"]["location"][0]["time"]["obsTime"]]
    station_dict = dict(zip(list_station, station_data))

    # set weather data value
    weather_dict = {}
    for i in weather_data["records"]["location"][0]["weatherElement"]:
        weather_dict[i["elementName"]] = i["elementValue"]

    station_dict.update(weather_dict)

    return station_dict

def get_city_station_data(city):
    # headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0'}
    # html = requests.get('https://e-service.cwb.gov.tw/wdps/obs/state.htm', headers=headers)
    # html.encoding = "utf-8"
    # soup = BeautifulSoup(html.text, 'html.parser')

    # data = soup.find_all('td')
    # data_list = [element.text if element.text != "" else "N/A" for element in data]

    # data, temp = defaultdict(dict), {}
    # for i in range(0, len(data_list)):
    #     if (i - 0) % 12 == 0: temp["id"] = data_list[i]
    #     if (i - 1) % 12 == 0: temp["name"] = data_list[i]
    #     if (i - 5) % 12 == 0:
    #         temp["city"] = data_list[i]
    #         data[temp["city"]][temp["name"]] = temp["id"]
    #         temp = {}

    raw = {"新北市": {"五分山雷達站": "466850", "板橋": "466880", "淡水": "C1A740", "山佳": "C0A520", "坪林": "C0A530", "四堵": "C0A540", "泰平": "C0A550", "福山": "C0A560", "桶後": "C0A570", "石碇": "C1A640", "火燒寮": "C1A650", "瑞芳": "C1A660", "大坪": "C0A860", "五指山": "C0A870", "福隆": "C0A880", "雙溪": "C0A890", "富貴角": "C0A920", "三和": "C0A930", "金山": "C0A940", "鼻頭角": "C0A950", "三貂角": "C0A970", "三峽": "C0AC60", "新莊": "C1ACA0", "三芝": "C0AD00", "八里": "C0AD10", "蘆洲": "C0AD30", "土城": "C0AD40", "鶯歌": "C0AD50", "中和": "C1AC90", "汐止": "C0AH00", "永和": "C0A9D0", "五分山": "C0AH30", "林口": "C1A710", "深坑": "C0AD20", "福山植物園": "C0AH90", "五股": "C1A680", "屈尺": "C0A580", "白沙灣": "C0AI20", "三重": "C0A9I1", "澳底": "C0AJ10", "野柳": "C0AJ20", "淡水觀海": "C0AJ30", "石門": "C0AJ40", "水湳洞": "C0AJ50", "下盆": "C1A630", "石碇服務區": "C1A750", "坪林交控": "C1A760", "四十份": "C1A9N0", "國一N039K": "C1AI60", "大豹": "C0A510", "大尖山": "C0A590", "南勢角": "C1A700"}, "臺北市": {"鞍部": "466910", "臺北": "466920", "竹子湖": "466930", "科教館": "C0A770", "社子": "C0A980", "天母": "C0A9C0", "內湖": "C0A9F0", "大屯山": "C0AC40", "信義": "C0A9H0", "文山": "C1AC80", "平等": "C0AH40", "松山": "C1A720", "石牌": "C0A9B0", "關渡": "C1A970", "國三N016K": "C1AI50", "臺北(師院)": "466921", "大崙尾山": "C0A990", "大直": "C0A9A0", "士林": "C0A9E0", "南港": "C0A9G0", "木柵": "C1A690", "公館": "C1A730"}, "基隆市": {"基隆": "466940", "彭佳嶼": "466950", "七堵": "C0B010", "基隆嶼": "C0B020", "大武崙": "C0B040", "八斗子": "C0B050"}, "花蓮縣": {"花蓮": "466990", "大禹嶺": "C0T790", "天祥": "C0T820", "鯉魚潭": "C0T870", "西林": "C1T900", "光復": "C0T960", "月眉山": "C0T9A0", "水源": "C0T9B0", "和中": "C0T9D0", "大坑": "C0T9E0", "水璉": "C0T9F0", "鳳林山": "C0T9G0", "加路蘭山": "C0T9H0", "豐濱": "C0T9I0", "靜浦": "C0S720", "富里": "C0T9N0", "明里": "C1Z020", "佳心": "C0Z050", "玉里": "C0Z060", "舞鶴": "C0Z070", "富源": "C0Z080", "東華": "C0Z100", "吉安光華": "C0Z150", "鳳林": "C1T930", "卓溪": "C0Z170", "新城": "C0T841", "富世": "C0T9C0", "萬榮": "C0Z200", "瑞穗": "C0Z210", "和平林道": "C0Z220", "和平": "C0Z230", "瑞穗林道": "C0Z250", "蕃薯寮": "C0Z270", "德武": "C0Z280", "赤柯山": "C0Z290", "東里": "C0Z300", "清水斷崖": "C0Z310", "清水林道": "C0Z320", "安通山": "C0Z330", "豐南": "C1S850", "洛韶": "C1T800", "慈恩": "C1T810", "布洛灣": "C1T830", "中興": "C1T920", "大觀": "C1T940", "太安": "C1T950", "大農": "C1T970", "龍澗": "C1T980", "高寮": "C1T990", "太魯閣": "C1TA00", "紅葉": "C1Z030", "立山": "C1Z040", "三棧": "C1Z090", "壽豐": "C1T890", "銅門": "C1T860", "荖溪": "C1Z140", "中平林道": "C1Z240", "豐裡": "C0Z260", "吉安": "C1T850", "吳全城": "C1T880", "東壙": "C1T910", "卓樂": "C1Z010"}, "桃園市": {"新屋": "C0C570", "復興": "C0C460", "桃園": "C1C480", "八德": "C1C490", "觀音": "C0C590", "蘆竹": "C1C620", "大溪": "C1C460", "平鎮": "C0C650", "楊梅": "C1C500", "龍潭": "C0C610", "龜山": "C0C640", "中壢": "C1C520", "大溪永福": "C0C710", "竹圍": "C0C720", "中大臨海站": "C0C730", "觀音工業區": "C0C740", "水尾": "C1C510", "大園": "C0C540", "五權": "C1C470", "埔心": "C1C540", "新屋-衛星中心": "C1C570"}, "宜蘭縣": {"蘇澳": "467060", "宜蘭": "467080", "雙連埤": "C1U521", "礁溪": "C0U600", "玉蘭": "C0U650", "太平山": "C0U710", "南山": "C1U720", "龜山島": "C0U750", "東澳": "C0U760", "南澳": "C0U770", "五結": "C0U780", "頭城": "C1U860", "大礁溪": "C1U610", "三星": "C1U660", "內城": "C0U900", "冬山": "C1U680", "羅東": "C0U640", "鶯子嶺": "C0U950", "翠峰湖": "C0U960", "大福": "C0U970", "坪林石牌": "C0U980", "員山": "C0U990", "土場": "C1U700", "鴛鴦湖": "C0UA10", "多加屯": "C0UA20", "白嶺": "C0UA30", "西德山": "C0UA40", "西帽山": "C0UA50", "樟樹山": "C0UA60", "桃源谷": "C0UA70", "大溪漁港": "C0UA80", "石城": "C0UA90", "淡江大學蘭陽校園": "C0UB00", "牛鬥": "C1U501", "寒溪": "C1U670", "新寮": "C1U690", "東澳嶺": "C1U840", "觀音海岸": "C1U850", "北關": "C1U580", "思源": "C0U730", "粉鳥林": "C1U930", "壯圍": "C1U620", "古魯": "C1U511", "再連": "C1U630", "烏石鼻": "C1U830"}, "金門縣": {"金門": "467110", "金沙": "C0W140", "金寧": "C0W150", "烏坵": "C0W160"}, "彰化縣": {"田中": "C0G850", "芬園": "C1G620", "鹿港": "C0G640", "員林": "C0G650", "溪湖": "C1G660", "溪州": "C1G670", "二林": "C0G730", "大城": "C0G740", "福興": "C0G770", "秀水": "C0G780", "埔鹽": "C0G800", "埔心": "C0G810", "田尾": "C0G820", "埤頭": "C0G830", "北斗": "C0G840", "社頭": "C0G860", "芳苑": "C0G870", "二水": "C0G880", "伸港": "C0G890", "線西": "C0G900", "花壇": "C0G790", "永靖": "C0G920", "竹塘": "C0G750", "下水埔": "C1G690", "國一S218K": "C1G9D0", "台西": "C0G710", "高鐵彰化": "C0G760", "彰化": "C1G631", "草湖": "C1G680", "中西": "C1G700"}, "澎湖縣": {"東吉島": "467300", "澎湖": "467350", "西嶼": "C0W120", "花嶼": "C0W130"}, "臺南市": {"臺南": "467410", "永康": "467420", "曾文": "C0O810", "北寮": "C1O830", "王爺宮": "C1O840", "大內": "C1O860", "善化": "C0O900", "玉井": "C0O930", "安南": "C0O950", "崎頂": "C1O960", "虎頭埤": "C1O970", "新市": "C1O980", "媽廟": "C1O990", "東河": "C1X050", "下營": "C1X060", "佳里": "C0X080", "臺南市北區": "C0X100", "臺南市南區": "C0X110", "麻豆": "C0X120", "官田": "C0X130", "西港": "C0X140", "安定": "C0X150", "仁德": "C0X160", "關廟": "C0X170", "山上": "C0X180", "安平": "C0X190", "左鎮": "C1O820", "白河": "C1X030", "學甲": "C0X220", "鹽水": "C0X230", "關子嶺": "C0X020", "新營": "C0O910", "後壁": "C0X260", "將軍": "C0X280", "北門": "C1X070", "鹿寮": "C0X300", "七股": "C1X090", "柳營": "C0X270", "沙崙": "C1N000", "環湖": "C1O850", "大棟山": "C1O870", "關山": "C1O880", "楠西": "C1O920", "東山服務區": "C1O940", "東原": "C1X040", "臺南(永康)": "467411", "南化": "C0O890", "和順": "C1O950", "岸內": "C1X010"}, "高雄市": {"高雄": "467440", "復興": "C1V210", "甲仙": "C0V250", "月眉": "C1V260", "美濃": "C0V310", "溪埔": "C1V350", "內門": "C0V360", "古亭坑": "C0V370", "阿公店": "C0V400", "鳳山": "C1V440", "鳳森": "C1V451", "新興": "C0V490", "阿蓮": "C1V530", "梓官": "C0V610", "永安": "C0V620", "茄萣": "C0V630", "湖內": "C0V640", "彌陀": "C0V650", "岡山": "C1V410", "楠梓": "C0V670", "仁武": "C0V680", "鼓山": "C0V690", "三民": "C0V700", "苓雅": "C0V710", "林園": "C0V720", "大寮": "C1V180", "旗山": "C1V330", "路竹": "C1V380", "橋頭": "C0V760", "大社": "C0V770", "萬山": "C0V790", "六龜": "C0V800", "左營": "C1V430", "小林": "C0V820", "達卡努瓦": "C1V160", "排雲": "C1V170", "南天池": "C1V190", "梅山": "C1V200", "小關山": "C1V220", "高中": "C1V230", "御油山": "C1V300", "大津": "C1V340", "尖山": "C1V390", "吉東": "C1V320", "溪南(特生中心)": "C1V580", "新發": "C1V240", "藤枝": "C1V280", "多納林道": "C1V780", "國三S383K": "C1V830", "表湖": "C0V150", "旗津": "C0V500", "三爺": "C1R180", "溪南": "C1V270", "新集": "C1V290", "木柵": "C1V360", "竹子腳": "C1V400", "鳳雄": "C1V420", "楠溪": "C1V460"}, "嘉義市": {"嘉義": "467480", "嘉義市東區": "C0M730"}, "臺中市": {"臺中": "467490", "大肚": "C1F000", "雪山圈谷": "C0F0A0", "石岡": "C1F920", "中坑": "C0F0C0", "審馬陣": "C0F0D0", "南湖圈谷": "C0F0E0", "東勢": "C1F850", "梨山": "C0F860", "大甲": "C1F930", "大坑": "C1F970", "中竹林": "C1F9A0", "神岡": "C1F9I0", "大安": "C0F9K0", "后里": "C0F9L0", "豐原": "C0F9M0", "大里": "C0F9N0", "潭子": "C0F9O0", "清水": "C0F9P0", "外埔": "C0F9Q0", "龍井": "C0F9R0", "烏日": "C0F9S0", "西屯": "C0F9T0", "南屯": "C0F9U0", "新社": "C0F9V0", "大雅(中科園區)": "C0F9X0", "桃山": "C0F9Y0", "雪山東峰": "C0F9Z0", "烏石坑": "C1F9H1", "松柏": "C0FA10", "溫寮": "C0FA20", "梧棲": "467770", "上谷關": "C1F870", "稍來": "C1F890", "新伯公": "C1F910", "雪嶺": "C1F940", "桐林": "C1F9B0", "白冷": "C1F9C0", "白毛台": "C1F9D0", "龍安": "C1F9E0", "伯公龍": "C1F9F0", "慶福山": "C1F9G0", "清水林": "C1I180", "德基": "C1F9W0", "雙崎": "C0F900", "橫山": "C1F990", "阿眉": "C1F880", "水湳": "C1F960", "炮子林": "C1F980"}, "嘉義縣": {"阿里山": "467530", "馬頭山": "C0M410", "東後寮": "C1M520", "奮起湖": "C0M530", "中埔": "C1M551", "朴子": "C1M510", "溪口": "C1M460", "大林": "C0M670", "太保": "C0M680", "水上": "C0M690", "竹崎": "C0M700", "東石": "C0M710", "番路": "C0M720", "六腳": "C0M740", "布袋": "C0M750", "民雄": "C0M760", "嘉義梅山": "C0M770", "鹿草": "C0M780", "新港": "C0M790", "茶山": "C0M800", "里佳": "C0M810", "達邦": "C0M820", "表湖": "C0M850", "新美": "C0M860", "龍美": "C1M390", "菜瓜坪": "C1M400", "獨立山": "C1M480", "頭凍": "C1M600", "石磐龍": "C1M610", "瑞里": "C1M620", "十字": "C1M640", "國三N285K": "C1M870", "山美": "C0M830", "新高口": "C1M440", "中坑": "C1M450", "鰲鼓": "C1M470", "內埔": "C1M490", "魚寮": "C1M500", "小公田": "C1M540", "南靖": "C1M560", "大湖": "C1M570", "豐山": "C1M630"}, "臺東縣": {"大武": "467540", "成功": "467610", "蘭嶼": "467620", "臺東": "467660", "下馬": "C1S660", "太麻里": "C0S690", "知本": "C0S700", "鹿野": "C0S710", "綠島": "C0S730", "池上": "C0S740", "向陽": "C0S750", "紅石": "C0S760", "大溪山": "C0S770", "金崙": "C0S790", "東河": "C1S640", "長濱": "C1S650", "南田": "C0S840", "關山": "C0S890", "蘭嶼高中": "C0S900", "蘭嶼燈塔": "C0S910", "金峰嘉蘭": "C0S920", "延平": "C0S930", "石寧山": "C0S940", "七塊厝": "C0S950", "香蘭": "C0S960", "加津林": "C0S970", "勝林山": "C0S980", "山豬窟": "C0S990", "歷坵": "C0SA00", "檳榔四格山": "C0SA10", "金崙山": "C0SA20", "都歷": "C0SA30", "瑞和": "C0SA40", "知本（水試所）": "C0SA60", "土坂": "C0SA80", "達仁林場": "C0SA90", "摩天": "C1S670", "華源": "C1S800", "金峰": "C1S820", "利嘉": "C1S860", "南美山": "C1S870", "壽卡": "C1S880", "利嘉林道": "C1SA50", "都蘭": "C1S630", "紅葉山": "C0S680", "土阪": "C1S620"}, "南投縣": {"玉山": "467550", "日月潭": "467650", "埔里": "C0H890", "中寮": "C1H950", "草屯": "C1H960", "昆陽": "C0H990", "神木村": "C0H9A0", "合歡山": "C0F950", "廬山": "C0I010", "信義": "C1I080", "鳳凰": "C0I090", "竹山": "C0I110", "水里": "C1I270", "魚池": "C1H910", "集集": "C1I170", "仁愛": "C1H870", "名間": "C0I410", "國姓": "C0I420", "南投": "C0I460", "梅峰": "C0I480", "萬大林道": "C0I490", "玉山風口": "C0I520", "小奇萊": "C0I530", "奇萊稜線": "C0I540", "翠峰": "C1H000", "國三N238K": "C1H840", "瑞岩": "C1H860", "清流": "C1H900", "長豐": "C1H920", "雙冬": "C1H940", "六分寮": "C1H970", "阿眉": "C1H9B0", "萬大": "C1I020", "武界": "C1I030", "丹大": "C1I050", "和社": "C1I070", "溪頭": "C1I100", "大鞍": "C1I120", "桶頭": "C1I130", "卡奈托灣": "C1I140", "青雲": "C1I150", "中心崙": "C1I200", "蘆竹湳": "C1I210", "樟湖": "C1I220", "九份二山": "C1I230", "外大坪": "C1I240", "鯉潭": "C1I250", "北坑": "C1I260", "埔中": "C1I280", "豐丘": "C1I290", "西巒": "C1I310", "奧萬大": "C1I320", "楓樹林": "C1I330", "新興橋": "C1I340", "凌霄": "C1H880", "翠華": "C1I430", "新高口": "C1I440", "望鄉山": "C1I450", "杉林溪": "C1I470", "大尖山": "C1I500", "線浸林道": "C1I510", "國六W023K": "C1I550", "中興新村": "C0H980", "翠巒": "C1H850", "大肚城": "C1H890", "北山": "C1H930", "文文社": "C1I040", "望鄉": "C1I060", "龍神橋": "C1I160", "水長流": "C1I190", "上安橋": "C1I300", "東埔": "C1I350"}, "新竹縣": {"新竹": "467571", "梅花": "C0D360", "關西": "C1D390", "峨眉": "C1D430", "打鐵坑": "C1D480", "橫山": "C0D540", "雪霸": "C0D550", "竹東": "C1D560", "寶山": "C0D580", "新豐": "C0C580", "湖口": "C1D370", "外湖": "C0D690", "新埔": "C1D380", "鳥嘴山": "C1D400", "白蘭": "C1D410", "太閣南": "C1D420", "飛鳳山": "C1D630", "外坪(五指山)": "C1D640", "觀霧": "C0E410"}, "屏東縣": {"恆春": "467590", "墾丁雷達站": "467790", "尾寮山": "C0R100", "阿禮": "C1R130", "瑪家": "C1R140", "三地門": "C0R150", "鹽埔": "C0R160", "屏東": "C1R170", "赤山": "C1R190", "潮州": "C0R220", "來義": "C1R240", "春日": "C1R260", "琉球嶼": "C0R270", "檳榔": "C0R280", "車城": "C1R320", "牡丹": "C1R340", "貓鼻頭": "C0R350", "大漢山": "C1R440", "高樹": "C0R470", "長治": "C0R480", "九如": "C0R490", "萬丹": "C0R510", "崁頂": "C0R520", "佳冬": "C0R540", "新埤": "C0R550", "新園": "C0R560", "麟洛": "C1R210", "南州": "C1R230", "里港": "C1R090", "舊泰武": "C0R600", "墾雷": "C0R620", "東港": "C0R430", "竹田": "C0R500", "枋寮": "C0R380", "楓港": "C0R400", "佳樂水": "C0R370", "墾丁": "C0R360", "枋山": "C1R330", "龍磐": "C0R710", "旭海": "C1R300", "大坪頂": "C0R730", "獅子": "C0R740", "四林格山": "C0R750", "南仁湖": "C0R760", "保力": "C0R770", "滿州": "C0R780", "九棚": "C0R790", "丹路": "C0R800", "內獅": "C0R810", "白鷺": "C0R820", "高士": "C0R830", "牡丹池山": "C0R420", "口社": "C1R110", "上德文": "C1R120", "力里": "C1R250", "石門山": "C1R290", "西大武山": "C1R610", "龍泉": "C1R201", "林邊": "C0R530", "新圍": "C1R160", "壽卡": "C1R310"}, "連江縣": {"馬祖": "467990", "東莒": "C0W110", "東引": "C0W170"}, "新竹市": {"新竹市東區": "C0D660", "海天一線": "C0D670", "香山濕地": "C0D680", "新竹": "C1D440", "香山": "C0D570"}, "苗栗縣": {"竹南": "C0E420", "南庄": "C0E430", "大湖": "C1E520", "後龍": "C1E540", "明德": "C1E550", "通霄": "C0E590", "馬都安": "C0E610", "頭份": "C0E730", "造橋": "C0E740", "苗栗": "C0E750", "銅鑼": "C0E780", "卓蘭": "C1E500", "西湖": "C0E810", "獅潭": "C0E820", "苑裡": "C0E760", "大河": "C1E440", "高鐵苗栗": "C0E870", "三義": "C0E530", "海埔": "C0E910", "通霄漁港": "C0E920", "龍鳳": "C0E930", "象鼻": "C1E450", "松安": "C1E460", "鳳美": "C1E480", "新開": "C1E510", "南勢": "C1E600", "南礦": "C1E670", "南勢山": "C1E680", "南湖": "C1E690", "八卦": "C1E700", "馬拉邦山": "C1E710", "泰安": "C1E720", "公館": "C1E570", "國三N149K": "C1E890", "國一N128K": "C1E900", "苑里": "C0E580", "馬達拉": "C1E470", "合流山": "C1E490", "和興": "C1E560", "土城": "C1E590"}, "雲林縣": {"草嶺": "C0K240", "崙背": "C1K250", "四湖": "C0K280", "宜梧": "C0K290", "虎尾": "C0K330", "土庫": "C1K340", "斗六": "C1K310", "北港": "C1K350", "西螺": "C1K230", "褒忠": "C1K270", "二崙": "C0K440", "大埤": "C0K450", "斗南": "C0K460", "林內": "C0K470", "莿桐": "C0K480", "元長": "C0K500", "水林": "C0K510", "臺西": "C0K530", "蔦松": "C0K550", "棋山": "C0K560", "高鐵雲林": "C0K580", "雲林東勢": "C0K520", "口湖": "C1K540", "大埔": "C0K300", "古坑": "C0K490", "後安寮": "C1K260", "阿丹": "C1K320", "山豬湖": "C1K380"}}

    return raw